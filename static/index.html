<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StÃ³Å‚ do Gry w 66</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="kontener-stolu">
        <div class="stolik">
            <div class="gracz gracz-gora" id="gracz-partner"></div>
            <div class="gracz gracz-lewo" id="gracz-lewy"></div>
            <div class="gracz gracz-prawo" id="gracz-prawy"></div>
            <div class="gracz gracz-dol" id="gracz-ty"></div>
            <div class="stol-srodek" id="stol-srodek"></div>
            <div id="wskaznik-atutu" class="wskaznik"></div>
            <div id="wskaznik-stawki" class="wskaznik"></div>
            <div class="koniec-gry-overlay" id="koniec-gry"></div>
        </div>
        <div class="panel-boczny">
            <div class="panel-info" id="info-o-grze"></div>
            <div class="panel-logu">
                <h3>Historia Meczu</h3>
                <div id="log-akcji"></div>
            </div>
        </div>
    </div>

    <script>
        // === ELEMENTY DOM ===
        const graczeDivs = {
            ty: document.getElementById('gracz-ty'),
            partner: document.getElementById('gracz-partner'),
            lewy: document.getElementById('gracz-lewy'),
            prawy: document.getElementById('gracz-prawy'),
        };
        const stolDiv = document.getElementById('stol-srodek');
        const infoDiv = document.getElementById('info-o-grze');
        const logDiv = document.getElementById('log-akcji');
        const koniecGryDiv = document.getElementById('koniec-gry');
        const atutDiv = document.getElementById('wskaznik-atutu');
        const stawkaDiv = document.getElementById('wskaznik-stawki');

        // === STAN LOKALNY ===
        let ostatniaHistoria = [];
        let ostatniaLiczbaKartNaStole = 0;
        let intervalID;

        // âœ… === POCZÄ„TEK ZMIANY 1: Spowolnienie reakcji po akcji gracza ===
        async function wykonajAkcje(url, event) {
            if (event) event.preventDefault();
            clearInterval(intervalID); // Zatrzymaj automatyczne odÅ›wieÅ¼anie

            try {
                // WyÅ›lij akcjÄ™ na serwer
                await fetch(url);
                // Natychmiast odÅ›wieÅ¼ stan, aby zobaczyÄ‡ swÃ³j ruch
                await odswiezStanGry();

                // Poczekaj chwilÄ™ (np. 750ms) zanim wznowisz automatyczne odÅ›wieÅ¼anie,
                // co da czas na reakcjÄ™ AI i pÅ‚ynniejsze przejÅ›cie.
                setTimeout(() => {
                    intervalID = setInterval(odswiezStanGry, 1200);
                }, 750);

            } catch (error) {
                console.error("BÅ‚Ä…d podczas wykonywania akcji:", error);
                // W razie bÅ‚Ä™du, od razu wznÃ³w odÅ›wieÅ¼anie
                intervalID = setInterval(odswiezStanGry, 1200);
            }
        }
        // âœ… === KONIEC ZMIANY 1 ===

        async function nowyMecz() {
            try {
                await fetch('/nowy_mecz');
                window.location.reload();
            } catch (error) {
                console.error("BÅ‚Ä…d podczas rozpoczynania nowego meczu:", error);
            }
        }

        // âœ… === POCZÄ„TEK ZMIANY 2: Ulepszone, trwaÅ‚e logowanie ===
        function renderujLog(nowaHistoria) {
            // JeÅ›li historia z serwera jest krÃ³tsza niÅ¼ ta, ktÃ³rÄ… mamy, to znaczy, Å¼e zaczÄ™Å‚o siÄ™ nowe rozdanie.
            if (nowaHistoria.length < ostatniaHistoria.length) {
                const separator = document.createElement('div');
                separator.className = 'log-info';
                separator.style.fontWeight = 'bold';
                separator.style.borderTop = '2px solid #ccc';
                separator.style.borderBottom = '2px solid #ccc';
                separator.textContent = '--- Nowe Rozdanie ---';
                logDiv.appendChild(separator);
                ostatniaHistoria = []; // Resetujemy lokalnÄ… historiÄ™
            }

            // ZnajdÅº tylko te akcje, ktÃ³rych jeszcze nie wyÅ›wietliliÅ›my
            const noweAkcjeDoDodania = nowaHistoria.slice(ostatniaHistoria.length);

            if (noweAkcjeDoDodania.length > 0) {
                noweAkcjeDoDodania.forEach(akcja => {
                    const [typ, gracz, reszta] = akcja.split(':', 3);
                    const logElement = document.createElement('div');
                    switch(typ) {
                        case 'KARTA':
                            logElement.className = 'log-karta';
                            logElement.innerHTML = `<b>${gracz}</b> zagrywa: ${reszta}`;
                            break;
                        case 'LEWA':
                             logElement.className = 'log-lewa';
                            logElement.innerHTML = `LewÄ™ wygrywa <b>${gracz}</b> (+${reszta} pkt)`;
                            break;
                        case 'MELDUNEK':
                             logElement.className = 'log-meldunek';
                             // Poprawka dla meldunku, aby poprawnie wyciÄ…gaÄ‡ punkty
                            logElement.innerHTML = `<b>${gracz}</b> melduje <b>${reszta.match(/\d+/)?.[0] || '?'}</b>!`;
                            break;
                        case 'INFO':
                             logElement.className = 'log-info';
                            logElement.textContent = `${gracz}: ${reszta || ''}`;
                            break;
                        default:
                            logElement.textContent = akcja;
                    }
                    logDiv.appendChild(logElement);
                });

                logDiv.scrollTop = logDiv.scrollHeight; // PrzewiÅ„ na sam dÃ³Å‚
                ostatniaHistoria = nowaHistoria; // Zaktualizuj ostatniÄ… znanÄ… historiÄ™
            }
        }
        // âœ… === KONIEC ZMIANY 2 ===

        function renderujWskazniki(stanGry) {
            stawkaDiv.innerHTML = `<div class="stawka-liczba">${stanGry.aktualna_stawka}</div><div class="stawka-opis">Stawka</div>`;
            stawkaDiv.title = `Aktualna wartoÅ›Ä‡ punktowa rozdania.`;
            atutDiv.innerHTML = '';
            const kontrakt = stanGry.kontrakt;
            if (kontrakt && kontrakt.typ) {
                const symbole = { CZERWIEN: 'â™¥', DZWONEK: 'â™¦', ZOLADZ: 'â™£', WINO: 'â™ ' };
                atutDiv.title = `Kontrakt: ${kontrakt.typ} (${kontrakt.atut || 'bez atu'}) ogÅ‚oszony przez ${kontrakt.gracz}.`;
                switch(kontrakt.typ) {
                    case 'NORMALNA':
                        if (kontrakt.atut) atutDiv.innerHTML = `<div class="atut-symbol ${kontrakt.atut}">${symbole[kontrakt.atut]}</div>`;
                        break;
                    case 'BEZ_PYTANIA':
                        if (kontrakt.atut) atutDiv.innerHTML = `<div class="korona">ðŸ‘‘</div><div class="atut-symbol ${kontrakt.atut}">${symbole[kontrakt.atut]}</div>`;
                        break;
                    case 'LEPSZA': case 'GORSZA':
                        atutDiv.innerHTML = `<div class="kontrakt-tekst">${kontrakt.typ.toLowerCase()}</div>`;
                        break;
                }
            } else {
                 atutDiv.title = 'Licytacja w toku.';
            }
        }

        function renderujGraczy(stanGry) {
            const pozycje = { [stanGry.gracze[0]]: 'ty', [stanGry.gracze[1]]: 'lewy', [stanGry.gracze[2]]: 'partner', [stanGry.gracze[3]]: 'prawy' };
            document.querySelectorAll('.gracz').forEach(el => el.classList.remove('podswietlony'));
            const pozycjaAktywnego = pozycje[stanGry.kolej_na];
            if(pozycjaAktywnego) graczeDivs[pozycjaAktywnego].classList.add('podswietlony');
            stanGry.gracze.forEach((nazwa, index) => {
                const pozycja = pozycje[nazwa];
                const iloscKart = stanGry.ilosc_kart_graczy[nazwa] || 0;
                const divGracza = graczeDivs[pozycja];
                const rozdajacyMarker = index === stanGry.rozdajacy_idx ? '<span class="rozdajacy-marker">ðŸ‘‘</span>' : '';
                if (pozycja === 'ty') {
                    const jestTuraGracza = stanGry.kolej_na === nazwa;
                    const legalneKarty = new Set(stanGry.legalne_karty_nazwy || []);
                    const kartyHTML = stanGry.reka_gracza.map(karta => {
                        if (jestTuraGracza && stanGry.faza_gry === 'ROZGRYWKA' && legalneKarty.has(karta.nazwa)) {
                            const akcjaUrl = `/zagraj_karte/${encodeURIComponent(karta.nazwa)}`;
                            return `<a href="#" onclick="wykonajAkcje('${akcjaUrl}', event)"><img src="/img/${karta.nazwa_pliku}" alt="${karta.nazwa}" class="karta-aktywna"></a>`;
                        }
                        return `<img src="/img/${karta.nazwa_pliku}" alt="${karta.nazwa}" class="karta-nieaktywna">`;
                    }).join('');
                    const akcjeHTML = stanGry.faza_gry !== 'ROZGRYWKA' && jestTuraGracza
                        ? stanGry.mozliwe_akcje.map(a => `<a href="#" onclick="wykonajAkcje('${a.url}', event)" class="akcja">${a.opis}</a>`).join('')
                        : '';
                    divGracza.innerHTML = `<div class="reka">${kartyHTML}</div><div class="nazwa-gracza">${nazwa}${rozdajacyMarker}</div><div class="akcje">${akcjeHTML}</div>`;
                } else {
                    divGracza.innerHTML = `<div class="nazwa-gracza">${nazwa}${rozdajacyMarker}</div><div class="reka">${Array(iloscKart).fill('<img src="/img/Rewers.png" alt="Karta" class="karta-odwrocona">').join('')}</div>`;
                }
            });
        }
        
        function renderujStol(stanGry) {
            const mapowaniePozycjiKart = { [stanGry.gracze[0]]: 'pozycja-dol', [stanGry.gracze[1]]: 'pozycja-lewo', [stanGry.gracze[2]]: 'pozycja-gora', [stanGry.gracze[3]]: 'pozycja-prawo' };
            const aktualnaLiczbaKartNaStole = stanGry.karty_na_stole.length;
            if (ostatniaLiczbaKartNaStole > 0 && aktualnaLiczbaKartNaStole === 0) {
                 const staryStol = stolDiv.cloneNode(true);
                 staryStol.style.position = 'absolute';
                 staryStol.style.opacity = '0.5';
                 stolDiv.parentNode.appendChild(staryStol);
                 setTimeout(() => staryStol.remove(), 800);
            }
            
            stolDiv.innerHTML = stanGry.karty_na_stole.map((z, index) => {
                const klasaPozycji = mapowaniePozycjiKart[z.gracz] || '';
                const klasaAnimacji = (index === aktualnaLiczbaKartNaStole - 1 && aktualnaLiczbaKartNaStole > ostatniaLiczbaKartNaStole) ? 'nowo-zagrana' : '';
                return `<div class="zagrana-karta ${klasaPozycji} ${klasaAnimacji}"><img src="/img/${z.nazwa_pliku}" alt="${z.karta}" class="karta"></div>`;
            }).join('');
            ostatniaLiczbaKartNaStole = aktualnaLiczbaKartNaStole;
        }

        async function odswiezStanGry() {
            try {
                const response = await fetch('/stan_gry');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const stanGry = await response.json();
                if (stanGry.koniec_meczu) {
                    koniecGryDiv.innerHTML = `<div><h2>Koniec Meczu!</h2><p>Wygrywa druÅ¼yna: <b>${stanGry.zwyciezca}</b></p><p>Wynik: ${stanGry.wynik}</p><a href="#" onclick="nowyMecz();" class="akcja">Nowy Mecz</a></div>`;
                    koniecGryDiv.style.display = 'flex';
                    clearInterval(intervalID);
                    return;
                }
                
                infoDiv.innerHTML = `<h3>Informacje</h3>
                    <div><strong>Faza:</strong> ${stanGry.faza_gry.replace('_', ' ')}</div>
                    <div><strong>Kontrakt:</strong> ${stanGry.kontrakt.typ ? `${stanGry.kontrakt.typ} (${stanGry.kontrakt.atut || 'brak atu'})` : 'Brak'}</div>
                    <div><strong>Punkty (rozdanie):</strong> My <b>${stanGry.punkty_w_rozdaniu.My}</b> - <b>${stanGry.punkty_w_rozdaniu.Oni}</b> Oni</div>
                    <div><strong>Punkty (mecz):</strong> My <b>${stanGry.ogolne_punkty_meczu.My}</b> - <b>${stanGry.ogolne_punkty_meczu.Oni}</b> Oni</div>`;
                renderujStol(stanGry);
                renderujGraczy(stanGry);
                renderujWskazniki(stanGry);
                renderujLog(stanGry.historia_akcji);
            } catch (error) {
                console.error("Nie udaÅ‚o siÄ™ pobraÄ‡ stanu gry:", error);
                infoDiv.innerHTML = "BÅ‚Ä…d poÅ‚Ä…czenia z serwerem.";
                clearInterval(intervalID);
            }
        }
        // === START APLIKACJI ===
        document.addEventListener('DOMContentLoaded', () => {
            odswiezStanGry();
            intervalID = setInterval(odswiezStanGry, 1200);
        });
    </script>
</body>
</html>