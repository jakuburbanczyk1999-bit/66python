<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StÃ³Å‚ do Gry w 66</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="kontener-stolu">
        <div class="stolik">
            <div class="gracz gracz-gora" id="gracz-partner"></div>
            <div class="gracz gracz-lewo" id="gracz-lewy-przeciwnik"></div>
            <div class="gracz gracz-prawo" id="gracz-prawy-przeciwnik"></div>
            <div class="gracz gracz-dol" id="gracz-ty"></div>
            <div class="stol-srodek" id="stol-srodek"></div>
            <div id="wskaznik-atutu"></div>
            <div id="wskaznik-stawki"></div>
            <div class="koniec-gry-overlay" id="koniec-gry"></div>
        </div>
        <div class="panel-boczny">
            <div class="panel-info" id="info-o-grze"></div>
            <div class="panel-logu">
                <h3>Historia Akcji</h3>
                <div id="log-akcji"></div>
            </div>
        </div>
    </div>

    <script>
        const graczeDivs = { ty: document.getElementById('gracz-ty'), partner: document.getElementById('gracz-partner'), lewyPrzeciwnik: document.getElementById('gracz-lewy-przeciwnik'), prawyPrzeciwnik: document.getElementById('gracz-prawy-przeciwnik'), };
        const stolDiv = document.getElementById('stol-srodek');
        const infoDiv = document.getElementById('info-o-grze');
        const logDiv = document.getElementById('log-akcji');
        const koniecGryDiv = document.getElementById('koniec-gry');
        const atutDiv = document.getElementById('wskaznik-atutu');
        const stawkaDiv = document.getElementById('wskaznik-stawki');
        
        let ostatniaHistoria = [];
        let ostatniaLiczbaKartNaStole = 0;
        let intervalID;

        async function wykonajAkcje(url, event) {
            event.preventDefault();
            // Natychmiastowe odÅ›wieÅ¼enie po akcji, aby animacja byÅ‚a pÅ‚ynna
            try { await fetch(url); await odswiezStanGry(); } catch (error) { console.error("BÅ‚Ä…d podczas wykonywania akcji:", error); }
        }

        async function nowyMecz() {
            try { await fetch('/nowy_mecz'); window.location.reload(); } catch (error) { console.error("BÅ‚Ä…d podczas rozpoczynania nowego meczu:", error); }
        }

        async function odswiezStanGry() {
            try {
                const response = await fetch('/stan_gry');
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const stanGry = await response.json();

                if (stanGry.koniec_meczu) {
                    koniecGryDiv.innerHTML = `<div><h2>Koniec Gry!</h2><p>Wygrywa: ${stanGry.zwyciezca}</p><p>Wynik: ${stanGry.wynik}</p><a href="#" onclick="event.preventDefault(); nowyMecz();" class="akcja">Nowy Mecz</a></div>`;
                    koniecGryDiv.style.display = 'flex';
                    clearInterval(intervalID);
                    return;
                }

                const nazwyGraczy = stanGry.gracze;
                const pozycje = { [nazwyGraczy[0]]: 'ty', [nazwyGraczy[1]]: 'lewyPrzeciwnik', [nazwyGraczy[2]]: 'partner', [nazwyGraczy[3]]: 'prawyPrzeciwnik' };
                const mapowaniePozycjiKart = { [nazwyGraczy[0]]: 'pozycja-dol', [nazwyGraczy[1]]: 'pozycja-lewo', [nazwyGraczy[2]]: 'pozycja-gora', [nazwyGraczy[3]]: 'pozycja-prawo' };
                
                const aktualnaLiczbaKartNaStole = stanGry.karty_na_stole.length;
                if (ostatniaLiczbaKartNaStole > 0 && aktualnaLiczbaKartNaStole === 0) {
                    const zwyciezcaLewy = stanGry.kolej_na;
                    const pozycjaZwyciezcy = pozycje[zwyciezcaLewy];
                    if (pozycjaZwyciezcy) {
                        const divZwyciezcy = graczeDivs[pozycjaZwyciezcy];
                        divZwyciezcy.classList.add('blysk-zwyciestwa');
                        setTimeout(() => { divZwyciezcy.classList.remove('blysk-zwyciestwa'); }, 1200);
                    }
                }
                
                // Renderowanie stoÅ‚u z logikÄ… animacji
                stolDiv.innerHTML = stanGry.karty_na_stole.map((z, index) => {
                    const klasaPozycji = mapowaniePozycjiKart[z.gracz] || '';
                    // Dodaj klasÄ™ animacji tylko jeÅ›li karta jest "nowa"
                    const klasaAnimacji = (index === aktualnaLiczbaKartNaStole - 1 && aktualnaLiczbaKartNaStole > ostatniaLiczbaKartNaStole) ? 'nowo-zagrana' : '';
                    return `<div class="zagrana-karta ${klasaPozycji} ${klasaAnimacji}"><img src="/img/${z.nazwa_pliku}" alt="${z.karta}" class="karta"></div>`;
                }).join('');
                
                ostatniaLiczbaKartNaStole = aktualnaLiczbaKartNaStole;

                // Renderowanie wskaÅºnikÃ³w
                stawkaDiv.innerHTML = `<div class="stawka-liczba">${stanGry.aktualna_stawka}</div><div class="stawka-opis">Stawka</div>`;
                atutDiv.innerHTML = '';
                const kontrakt = stanGry.kontrakt;
                if (kontrakt && kontrakt.typ) {
                    const symbole = { CZERWIEN: 'â™¥', DZWONEK: 'â™¦', ZOLADZ: 'â™£', WINO: 'â™ ' };
                    switch(kontrakt.typ) {
                        case 'NORMALNA':
                            if (kontrakt.atut) atutDiv.innerHTML = `<div class="atut-symbol ${kontrakt.atut}">${symbole[kontrakt.atut]}</div>`; break;
                        case 'BEZ_PYTANIA':
                            if (kontrakt.atut) atutDiv.innerHTML = `<div class="korona">ðŸ‘‘</div><div class="atut-symbol ${kontrakt.atut}">${symbole[kontrakt.atut]}</div>`; break;
                        case 'LEPSZA': case 'GORSZA':
                            atutDiv.innerHTML = `<div class="kontrakt-tekst">${kontrakt.typ.toLowerCase()}</div>`; break;
                    }
                }
                
                document.querySelectorAll('.gracz').forEach(el => el.classList.remove('podswietlony'));
                const pozycjaAktywnego = pozycje[stanGry.kolej_na];
                if(pozycjaAktywnego) graczeDivs[pozycjaAktywnego].classList.add('podswietlony');

                nazwyGraczy.forEach(nazwa => {
                    const pozycja = pozycje[nazwa];
                    const iloscKart = stanGry.ilosc_kart_graczy[nazwa] || 0;
                    const divGracza = graczeDivs[pozycja];
                    if (pozycja === 'ty') {
                        let kartyHTML = '';
                        if (stanGry.faza_gry === 'ROZGRYWKA' && stanGry.kolej_na === nazwa) {
                            const legalneAkcjeMap = new Map(stanGry.mozliwe_akcje.map(akcja => [akcja.opis, akcja.url]));
                            kartyHTML = stanGry.reka_gracza.map(karta => {
                                if (legalneAkcjeMap.has(karta.nazwa)) {
                                    const url = legalneAkcjeMap.get(karta.nazwa);
                                    return `<a href="${url}" onclick="wykonajAkcje('${url}', event)"><img src="/img/${karta.nazwa_pliku}" alt="${karta.nazwa}" class="karta-aktywna"></a>`;
                                } else {
                                    return `<img src="/img/${karta.nazwa_pliku}" alt="${karta.nazwa}" class="karta-nieaktywna">`;
                                }
                            }).join('');
                        } else {
                            kartyHTML = stanGry.reka_gracza.map(karta => `<img src="/img/${karta.nazwa_pliku}" alt="${karta.nazwa}" class="karta-nieaktywna">`).join('');
                        }
                        const akcjeHTML = stanGry.mozliwe_akcje.map(a => `<a href="${a.url}" onclick="wykonajAkcje('${a.url}', event)" class="akcja">${a.opis}</a>`).join('');
                        const finalneAkcjeHTML = stanGry.faza_gry !== 'ROZGRYWKA' ? akcjeHTML : '';
                        divGracza.innerHTML = `<div class="reka">${kartyHTML}</div><div class="nazwa-gracza">${nazwa}</div><div class="akcje">${finalneAkcjeHTML}</div>`;
                    } else {
                         divGracza.innerHTML = `<div class="nazwa-gracza">${nazwa}</div><div class="reka">${Array(iloscKart).fill('<img src="/img/Rewers.png" alt="Karta" class="karta-odwrocona">').join('')}</div>`;
                    }
                });

                infoDiv.innerHTML = `<h3>Informacje</h3><div><strong>Faza:</strong> ${stanGry.faza_gry}</div><div><strong>Kontrakt:</strong> ${stanGry.kontrakt.typ || 'Brak'} ${stanGry.kontrakt.atut ? `(${stanGry.kontrakt.atut})` : ''}</div><div><strong>Punkty (rozdanie):</strong> My ${stanGry.punkty_w_rozdaniu.My} - ${stanGry.punkty_w_rozdaniu.Oni} Oni</div><div><strong>Punkty (mecz):</strong> My ${stanGry.ogolne_punkty_meczu.My} - ${stanGry.ogolne_punkty_meczu.Oni} Oni</div>`;

                if (stanGry.historia_akcji && stanGry.historia_akcji.length !== ostatniaHistoria.length) {
                    logDiv.innerHTML = stanGry.historia_akcji.map(akcja => `<div>${akcja}</div>`).join('');
                    logDiv.scrollTop = logDiv.scrollHeight;
                    ostatniaHistoria = stanGry.historia_akcji;
                }
            } catch (error) {
                console.error("Nie udaÅ‚o siÄ™ pobraÄ‡ lub przetworzyÄ‡ stanu gry:", error);
                infoDiv.innerHTML = "BÅ‚Ä…d poÅ‚Ä…czenia z serwerem. SprawdÅº konsolÄ™ serwera.";
            }
        }

        intervalID = setInterval(odswiezStanGry, 1500);
        odswiezStanGry();
    </script>
</body>
</html>