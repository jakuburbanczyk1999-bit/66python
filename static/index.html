<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gra w 66</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f0f0; display: flex; flex-direction: column; align-items: center; }
        .kontener-gry { width: 90%; max-width: 800px; background-color: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 20px; margin-top: 20px; }
        h1, h2 { text-align: center; color: #333; }
        h2 { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-top: 25px; }
        .info-o-grze, .karty-na-stole, .reka-gracza, .mozliwe-akcje { margin-top: 15px; }
        .info-o-grze div, .karty-na-stole div { background-color: #fafafa; border: 1px solid #eee; padding: 10px; border-radius: 4px; margin-bottom: 5px; }
        .reka-gracza { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; min-height: 50px; }
        .mozliwe-akcje { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; min-height: 50px; }
        .karta { padding: 15px 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05); color: #555; }
        .akcja { padding: 15px 20px; border: 1px solid #0275d8; color: #0275d8; text-decoration: none; border-radius: 8px; background-color: #fff; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .akcja:hover { background-color: #0275d8; color: white; }
        .koniec-gry { text-align: center; font-size: 1.5em; color: #d9534f; padding: 40px; }
        .punkty { font-weight: bold; }
        .punkty-my { color: #0275d8; }
        .punkty-oni { color: #f0ad4e; }
    </style>
</head>
<body>
    <div class="kontener-gry">
        <h1>Gra w 66</h1>

        <div class="info-o-grze" id="info-o-grze"></div>
        
        <h2>Karty na Stole</h2>
        <div class="karty-na-stole" id="karty-na-stole"></div>

        <h2>Twoja Ręka</h2>
        <div class="reka-gracza" id="reka-gracza"></div>

        <h2>Możliwe Akcje</h2>
        <div class="mozliwe-akcje" id="mozliwe-akcje"></div>

        <div class="koniec-gry" id="koniec-gry" style="display: none;"></div>
    </div>

    <script>
        const infoDiv = document.getElementById('info-o-grze');
        const stolDiv = document.getElementById('karty-na-stole');
        const rekaDiv = document.getElementById('reka-gracza');
        const akcjeDiv = document.getElementById('mozliwe-akcje');
        const koniecGryDiv = document.getElementById('koniec-gry');

        // === NOWA FUNKCJA DO OBSŁUGI KLIKNIĘĆ ===
        // Ta funkcja będzie wywoływana po kliknięciu na akcję.
        // Zapobiegnie przeładowaniu strony i wyśle zapytanie w tle.
        async function wykonajAkcje(url, event) {
            // event.preventDefault() zatrzymuje domyślne zachowanie linku (przejście do nowej strony)
            event.preventDefault();
            
            try {
                // Wyślij zapytanie do API w tle
                await fetch(url);
                // Natychmiast po wykonaniu akcji, odśwież stan gry, aby zobaczyć rezultat
                odswiezStanGry();
            } catch (error) {
                console.error("Błąd podczas wykonywania akcji:", error);
            }
        }

        // Główna funkcja do aktualizacji interfejsu
        async function odswiezStanGry() {
            try {
                const response = await fetch('/stan_gry');
                const stanGry = await response.json();

                if (stanGry.koniec_meczu) {
                    koniecGryDiv.innerHTML = `<h2>Koniec Gry!</h2><p>Wygrywa drużyna: ${stanGry.zwyciezca}</p><p>Wynik: ${stanGry.wynik}</p><a href="/nowy_mecz" class="akcja">Nowy Mecz</a>`;
                    koniecGryDiv.style.display = 'block';
                    infoDiv.style.display = 'none';
                    stolDiv.style.display = 'none';
                    rekaDiv.style.display = 'none';
                    akcjeDiv.style.display = 'none';
                    // Zatrzymujemy interwał odświeżania po końcu gry
                    clearInterval(intervalID);
                    return;
                }

                infoDiv.innerHTML = `
                    <div>Faza Gry: <strong>${stanGry.faza_gry}</strong></div>
                    <div>Kolej na: <strong>${stanGry.kolej_na}</strong></div>
                    <div>Kontrakt: <strong>${stanGry.kontrakt.typ || 'Brak'} ${stanGry.kontrakt.atut ? `(${stanGry.kontrakt.atut})` : ''}</strong></div>
                    <div>Punkty w rozdaniu: <span class="punkty punkty-my">My ${stanGry.punkty_w_rozdaniu.My}</span> - <span class="punkty punkty-oni">${stanGry.punkty_w_rozdaniu.Oni} Oni</span></div>
                    <div>Punkty w meczu: <span class="punkty punkty-my">My ${stanGry.ogolne_punkty_meczu.My}</span> - <span class="punkty punkty-oni">${stanGry.ogolne_punkty_meczu.Oni} Oni</span></div>
                `;

                if (stanGry.karty_na_stole.length > 0) {
                    stolDiv.innerHTML = stanGry.karty_na_stole.map(z => `<div><strong>${z.gracz}:</strong> ${z.karta}</div>`).join('');
                } else {
                    stolDiv.innerHTML = '<div>Brak kart na stole.</div>';
                }

                rekaDiv.innerHTML = stanGry.reka_gracza.map(k => `<div class="karta">${k.nazwa}</div>`).join('');

                // === ZMODYFIKOWANA LINIJKA ===
                // Teraz każdy link ma dodane zdarzenie 'onclick', które wywołuje naszą nową funkcję.
                akcjeDiv.innerHTML = stanGry.mozliwe_akcje.map(a => `<a href="${a.url}" onclick="wykonajAkcje('${a.url}', event)" class="akcja">${a.opis}</a>`).join('');

            } catch (error) {
                console.error("Nie udało się pobrać stanu gry:", error);
                infoDiv.innerHTML = "Błąd połączenia z serwerem gry.";
            }
        }

        // Uruchom odświeżanie co 1.5 sekundy
        const intervalID = setInterval(odswiezStanGry, 1500);
        // Uruchom od razu po załadowaniu strony
        odswiezStanGry();
    </script>
</body>
</html>